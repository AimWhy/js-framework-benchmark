/*! For license information please see doo.html.fn.min.js.LICENSE.txt */
(()=>{"use strict";const e="bind",t="{{",a="}}",l="shadow";class n extends HTMLElement{static get version(){return"v0.96.1-beta"}static define(e,t=null){let a=t||e.name.toLowerCase();customElements.define("doo-"+a,e)}constructor(e=12){super(),this.PAGE_SIZE=e,this.data={},this.place=[],this.template=void 0,this.visibleColumns=[],this.dataHasHtml=!1,this.dataHydrate=!1}static get observedAttributes(){return["data-hydrate","data-has-html","data-key","data-template","bind","data-bind","data-page-size","page-size"]}async attributeChangedCallback(e,t,a){a.length>0&&t!==a&&("page-size"===e?this.PAGE_SIZE=a:"data-key"===e?this.dataKey=a:"data-has-html"===e?this.dataHasHtml=a:"data-hydrate"===e?this.dataHydrate=a:"debug"===e&&(Doo.debug=!0))}async connectedCallback(){let e=this.getAttribute("context")||l;this.shadow=e===l?this.attachShadow({mode:"open"}):document,!this.defaultDataSet&&this.getAttribute("bind")&&(this.defaultDataSet=this.getAttribute("bind")),this.scrollTarget&&(this.scrollElem=this.shadow.querySelector(this.scrollTarget)),this.template=this.getAttribute("template"),this.templateNode=await this.createDooTemplate(this.template),this.templateElem=this.templateNode.content,this.initReactiveDataNodes(this.templateNode),this.setContext(),"function"==typeof this.dooAfterRender&&await this.dooAfterRender()}fetchTemplate(e){return new Promise(((t,a)=>{const l=new XMLHttpRequest;l.open("GET",e),l.onload=()=>t(l.responseText),l.onerror=()=>a(l.statusText),l.send()}))}async createDooTemplate(e){let t="";t=0===e.indexOf("#")?document.querySelector(e).outerHTML:await this.fetchTemplate(e);let a=document.createElement("div");a.innerHTML=t,a.querySelector("template")&&(a.innerHTML=a.querySelector("template")?t:`<template><center><pre>The template you are trying to import does not have a &lt;template&gt tag</pre><div style="color:red">${this.template}</div></enter></template>`);let l=a.querySelector("template").cloneNode(!0);l.removeAttribute("id");let n=document.createElement("template");return n.innerHTML=l.innerHTML,n}initReactiveDataNodes(l){const n=e=>{let t=0;for(;e.parentElement;)e=e.parentElement,t++;return t};let o=l.content.querySelectorAll('[data-src="${data-map}"]');o.length>0&&[...o].forEach((e=>{let t=[];this.dataMap.forEach(((e,a)=>{let l=void 0===this.flex[a]?1:this.flex[a],n=e.split(":"),o=n.length>1?n[1]:n[0],i="";l.includes(":")&&(i=l.split(":").length>2?"doo-center":"doo-end",l=l.replace(/:/g,"")),t.push({label:o,fieldName:this.dynamicField(n[0]),flex:l,flexJustify:i})}));let a=this.htmlParse(e,t),l=e.parentElement;l.removeChild(e),l.innerHTML=a+l.innerHTML})),l.innerHTML=l.innerHTML.replace(/\$\{(.+?)\}/gm,((e,n)=>isNaN(n)?this.hasAttribute(n)?this.getAttribute(n):l.hasAttribute(n)?l.getAttribute(n):"":this.dataMap.length>0?t+this.dataMap[n-1]+a:void 0)),[...l.content.querySelectorAll("[bind]")].forEach((e=>{if(!e.hasAttribute("data-src")){let t=this.hasAttribute("doo-dispatch")?"DooX":"this.data";e.setAttribute("data-src",t)}}));let i,s=l.content.querySelectorAll("[data-src]"),r=s.length,d=[];for(let t=0;t<r;t++){let a=s[t].getAttribute(e),l=s[t].getAttribute("data-src");l&&this.setAttribute("doo-dispatch",a),0===l.indexOf("this.parent")&&(s[t].useParent=!0),s[t].removeAttribute("data-src"),s[t].level=n(s[t]),d.push(s[t])}this.removeAttribute("data-map"),this.removeAttribute("flex"),this.removeAttribute("data-fetch"),d=d.toSorted(((e,t)=>e.level===t.level?0:e.level>t.level?1:-1)).reverse();for(let t=0;t<r;t++){i="|STYLE|LINK|".indexOf(`|${d[t].tagName}|`)>-1?d[t]:d[t].parentElement&&("void"===s[t].getAttribute(e)||"|DL|UL|TBODY|THEAD|TFOOT|TR|SELECT|SECTION|".indexOf(`|${d[t].parentElement.tagName}|`)>-1)?d[t].parentElement:document.createElement("data"),i.dataKey=d[t].getAttribute(e);let a=this.dooParse(d[t],this,this.dataMap);i.processNode=a.processNode,i.xHtml=a.xHtml,i.dataSlots=a.dataSlots,i.name=t,i.level=n(d[t]),i.useParent=d[t].useParent,i.noRepeat=d[t].hasAttribute("data-norepeat"),"DATA"!==i.tagName&&"STYLE"!==i.tagName&&"LINK"!==i.tagName||(d[t].parentElement?d[t].parentElement.replaceChild(i,d[t]):(console.log("Warning: Templates should only have one child node"),d[t].appendChild(i))),this.place.push(i)}return this.place}dooParse(t){let a=t.cloneNode(!0);a.removeAttribute(e),a.removeAttribute("data-key");let l=a.outerHTML.replace(/\t/g,"").replace(/\n/g,""),n=l;["src","selected","checked","disabled","readonly"].forEach((e=>{l=l.replace(new RegExp(" "+e+'="{{(.+)}}"',"g")," doo-"+e+'="{{$1}}"')}));let o=n===l,i=document.createElement("template");i.innerHTML=l;let s=[];const r=(e,t,a)=>{let l=[],n=e;for(;n!==i.firstElementChild;){let e=n.previousSibling,t=0;for(;e;)t++,e=e.previousSibling;n=n.parentNode,n&&l.unshift(t)}s.push([t,l.slice(1),a])},d=document.createTreeWalker(i.content,NodeFilter.SHOW_TEXT,{acceptNode:()=>NodeFilter.FILTER_ACCEPT});let h=d.nextNode(),c=[];for(;h;){let e=h.wholeText.trim();if(0===e.indexOf("{{")&&e.lastIndexOf("}}")===e.length-2);else{let t=e.replace(/{{/g,"<span>{{").replace(/}}/g,"}}</span>");c.push({node:h.parentNode,oldText:e,newText:t})}h=d.nextNode()}for(let e=0,t=c.length;e<t;e++)c[e].node.innerHTML=c[e].node.innerHTML.replace(c[e].oldText,c[e].newText);let p=i.content.cloneNode(!0);const m=document.createTreeWalker(p,NodeFilter.SHOW_TEXT,{acceptNode:()=>NodeFilter.FILTER_ACCEPT});let u=m.nextNode();for(;u;)0===u.textContent.trim().indexOf("{{")&&r(u,u.textContent.replace("{{","").replace("}}",""),"textContent"),u=m.nextNode();const g=document.createTreeWalker(p,NodeFilter.SHOW_ELEMENT,{acceptNode:()=>NodeFilter.FILTER_ACCEPT});for(u=g.nextNode();u;){for(const e of[...u.attributes])e.nodeValue.includes("{{")&&r(u,e.nodeValue.replace("{{","").replace("}}",""),e.name);u=g.nextNode()}let T=p.firstElementChild.outerHTML;return s.forEach((e=>{let t="{{"+e[0]+"}}";T=T.replace(new RegExp(t,"g"),"")})),p.outerHTML=T,{processNode:p.firstElementChild,xHtml:o,dataSlots:s}}render(t=null,a=0,l=null){if(!this.template)return console.error(this.name+" has no template defined"),console.log("You need to set a data-template attribute on the <doo-html /> component"),console.log("You can reference you data-template by a template id"),console.log('Example: <doo-html data-template="#t1" .../>'),console.log("Templates can also be external and you can use relative path to access it"),void console.log('Example: <doo-html data-template="./templates/t1.html" .../>');this.place||console.log("No target set on the component or inside the template. USAGE: set the data-bind=[your data pointer]");for(let n=0,o=this.place.length;n<o;n++){if("TR"===this.place[n].tagName||"TBODY"===this.place[n].tagName||"TABLE"===this.place[n].tagName)continue;if(t&&t!==this.place[n].dataKey){this.renderHTML(t,this.place[n],a);continue}if(0===a&&"STYLE"!==this.place[n].tagName&&!this.place[n].classList.contains("fhead")){let t="dummy"===this.place[n].getAttribute(e)?-1:0;this.place[n].setAttribute("page",t)}let o=this.place[n].dataKey,i=this.place[n].noRepeat?1:this.PAGE_SIZE;null===l?this.renderHTML(this.place[n],o,a*this.PAGE_SIZE,i):this.place[n].append(this.renderHTML(this.place[n],o,l,1))}}async setContext(){this.childNodes.length>0&&this.getElementsByTagName("template")&&this.getElementsByTagName("template").length>0&&this.removeChild(this.getElementsByTagName("template").item(0)),this.componentContainer=this.parentElement,this.componentContainer.replaceChild(this.templateElem,this),this.renderTable([],this.place[0],0),this.componentContainer.style.visibility="visible"}renderHTML(e,t,a=0,l=this.PAGE_SIZE){let n,o,i=e.length,s=a+l;s>i&&(s=i);let r=t.dataSlots.length;const d=(e,t,a)=>{let l=t[a];return e.childNodes[l]?d(e.childNodes[l],t,++a):e},h=(a,l)=>{for(let n=0;n<r;n++)o=d(a,t.dataSlots[n][1],0),o?"textContent"===t.dataSlots[n][2]?o.textContent=e[l][t.dataSlots[n][0]]:o.setAttribute(t.dataSlots[n][2],e[l][t.dataSlots[n][0]]):console.info("Field:"+t.dataSlots[n][0]+" does not exist")};if(this.dataHydrate){let l=t.querySelectorAll(t.processNode.tagName);for(let o=a;o<s;o++){let a=l.item(o);n=a||t.processNode,h(n,o),a||(t.appendChild(n.cloneNode(!0)).key=this.getItemValue(e[o],this.dataKey))}}else for(let l=a;l<s;l++)n=t.processNode,h(n,l),t.appendChild(n.cloneNode(!0)).key=this.getItemValue(e[l],this.dataKey)}getItemValue(e,t){return e[t]?e[t]:""}showComponentContainer(e){this.componentContainer.style.visibility=e?"visible":"hidden"}renderTable(e=this.data[this.defaultDataSet],t=this.place[0],a=0){let l=e.length;0!==l?(t.childNodes.length>l&&(t.textContent=""),this.renderHTML(e,t,a,l-a)):t.textContent=""}append(e=this.data[this.defaultDataSet],t=this.place[0],a=0){const l=t.firstElementChild.tagName;t.childNodes.length>0&&l.startsWith("TR")||l.startsWith("TBODY")||l.startsWith("TBODY")||l.startsWith("THEAD")?this.renderTable(e,t,a):this.renderHTML(t,e,a,e.length-a,!0)}getIndex(e,t,a=this.data[this.defaultDataSet]){return a.findIndex(((a,l)=>{if(a[t]===e.key)return l}))}}window.DooHTML||(window.Doo=n,window.DooHTML=n)})();